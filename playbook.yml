- name: set up azure-vm
  hosts: azure-vm
  become: yes
  become_method: sudo
  remote_user: "{{ AZ_user }}"

  vars_prompt:
    - name: mytoken
      prompt: what is your discord token ?
      default: "ODIxMzg2Nzg4NjE4MTA4OTU4.YFC-Dw.lmIxsbFiF5UXS_i13asqRbSlNzg"
      private: no

  tasks:
    - name: Install Packages
      apt: name={{ item }} update_cache=yes state=latest
      with_items:
        - build-essential
        - git
        - mcrypt
        - nginx

    - name: ensure apt cache is up to date
      apt: update_cache=yes

    - name: change npm version
      shell: "curl -fsSL https://deb.nodesource.com/setup_15.x | sudo -E bash -"

    - name: set up npm and node.js lastest
      command: sudo apt-get install -y nodejs

    # - name: remove all element
    #   ansible.builtin.shell: rm -rf Bot-Discord
    #   args:
    #     executable: /bin/bash

    - name: clone git repository
      git:
        repo: "https://github.com/{{ github_user }}/{{ app_name }}.git"
        dest: /home/{{ AZ_user }}/{{ app_name }}
        version: ansible
        update: yes
      register: git_finished

    - name: create file .env
      copy:
        dest: /home/{{ AZ_user }}/{{ app_name }}/.env
        content: |
          TOKEN="{{mytoken}}"

    # - name: install packages bases on package.json
    #   community.general.npm:
    #     path: /home/{{ AZ_user }}/{{ app_name }}

    # - name: update packages
    #   community.general.npm:
    #     path: /home/{{ AZ_user }}/{{ app_name }}
    #     state: latest

    - name: install npm package
      npm: path=/home/{{ AZ_user }}/{{ app_name }}
      when: git_finished.changed


    - name: execute npm watch
      become_method: sudo
      command: npm run watch
      args:
        chdir: /home/{{ AZ_user }}/{{ app_name }}
      register: watch_finished
      when: npm_install_package.changed

    - name: execute npm start
      become_method: sudo
      command: npm run start
      args:
        chdir: /home/{{ AZ_user }}/{{ app_name }}
      when: watch_finished.changed
